name: Terraform Infrastructure

# This workflow runs in two scenarios:
# 1. On PR/push to validate and plan terraform changes
# 2. After 'Build Test Publish' workflow completes successfully on main branch
#    (ensures Docker images are published before infrastructure deployment)

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-infrastructure.yml'
  workflow_run:
    workflows: [ "Build Test Publish" ]
    types:
      - completed
    branches: [ main ]

env:
  TF_VERSION: '1.13.3'
  AWS_REGION: us-east-1
  TF_IN_AUTOMATION: true
  TF_INPUT: false
  DEFAULT_LAST_LAYER: '4'
  ENVIRONMENT: 'staging'

permissions:
  id-token: write
  contents: read
  security-events: write  # Required for SARIF uploads
  pull-requests: write    # Required for PR comments

jobs:
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest

    outputs:
      terraform-version: ${{ steps.extract-terraform-version.outputs.terraform-version }}
      is-prerelease: ${{ steps.extract-terraform-version.outputs.is-prerelease }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract Terraform Version
      id: extract-terraform-version
      run: |
        cd terraform
        # Extract version from staging.tfvars
        TERRAFORM_VERSION=$(grep '^infrastructure_version = ' staging.tfvars | sed 's/.*= "\(.*\)"/\1/')

        # Check if it's a pre-release version
        if [[ "$TERRAFORM_VERSION" == *"-alpha"* ]] || [[ "$TERRAFORM_VERSION" == *"-beta"* ]] || [[ "$TERRAFORM_VERSION" == *"-rc"* ]]; then
          IS_PRERELEASE="true"
          echo "ðŸš§ **Terraform Infrastructure Version: \`$TERRAFORM_VERSION\` (pre-release)**" >> $GITHUB_STEP_SUMMARY
        else
          IS_PRERELEASE="false"
          echo "ðŸ—ï¸ **Terraform Infrastructure Version: \`$TERRAFORM_VERSION\`**" >> $GITHUB_STEP_SUMMARY
        fi

        echo "terraform-version=$TERRAFORM_VERSION" >> $GITHUB_OUTPUT
        echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

    - name: Validate Version Change (PR only)
      if: github.event_name == 'pull_request'
      env:
        TERRAFORM_VERSION: ${{ steps.extract-terraform-version.outputs.terraform-version }}
      run: |
        # Get version from main branch
        git fetch origin main
        git checkout origin/main -- terraform/staging.tfvars
        MAIN_VERSION=$(grep --no-messages '^infrastructure_version = ' terraform/staging.tfvars | sed 's/.*= "\(.*\)"/\1/')
        if [[ -z "$MAIN_VERSION" ]]; then MAIN_VERSION="0.0.0-alpha.0"; fi
        git checkout HEAD -- terraform/staging.tfvars

        echo "Current PR terraform version: $TERRAFORM_VERSION"
        echo "Main branch terraform version: $MAIN_VERSION"

        # Extract base version (remove pre-release suffix if present)
        CURRENT_BASE=$(echo "$TERRAFORM_VERSION" | cut -d'-' -f1)
        MAIN_BASE=$(echo "$MAIN_VERSION" | cut -d'-' -f1)

        echo "Current base version: $CURRENT_BASE"
        echo "Main base version: $MAIN_BASE"

        # Check if it's a pre-release version
        if [[ "$TERRAFORM_VERSION" == *"-alpha"* ]] || [[ "$TERRAFORM_VERSION" == *"-beta"* ]] || [[ "$TERRAFORM_VERSION" == *"-rc"* ]]; then
          echo "ðŸš§ Pre-release infrastructure version detected: $TERRAFORM_VERSION"
          # For pre-release: base version must be > main base version
          if [ "$CURRENT_BASE" = "$MAIN_BASE" ]; then
            echo "âŒ ERROR: Pre-release base version ($CURRENT_BASE) must be greater than main version ($MAIN_BASE)"
            echo "Example: If main is 1.0.1, use 1.0.2-alpha.1 (not 1.0.1-alpha.1)"
            exit 1
          fi
          echo "âœ… Pre-release infrastructure version validation passed: $MAIN_VERSION â†’ $TERRAFORM_VERSION"
          echo "## ðŸš§ Pre-release Infrastructure Version Update" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous**: \`$MAIN_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Current**: \`$TERRAFORM_VERSION\` (pre-release)" >> $GITHUB_STEP_SUMMARY
          echo "- **âš ï¸ Note**: Infrastructure deployment will be suppressed" >> $GITHUB_STEP_SUMMARY
        else
          # For production releases: version must be different
          if [ "$TERRAFORM_VERSION" = "$MAIN_VERSION" ]; then
            echo "âŒ ERROR: Terraform infrastructure version must be incremented for PR merge"
            echo "Current version: $TERRAFORM_VERSION"
            echo "Please update terraform/staging.tfvars with a new infrastructure_version"
            exit 1
          fi
          echo "âœ… Production infrastructure version validation passed: $MAIN_VERSION â†’ $TERRAFORM_VERSION"
          echo "## ðŸŽ¯ Production Infrastructure Version Update" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous**: \`$MAIN_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Current**: \`$TERRAFORM_VERSION\` (production)" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        # AWS Role Trusts GitHub OIDC identity provider
        role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Format Check - Layered Architecture
      run: |
        cd terraform
        # Check format for each layer
        for layer in 01-foundation 02-data 03-database 04-compute 05-monitoring; do
          echo "Checking format for layer: $layer"
          terraform fmt -check -recursive -diff $layer/
        done
      continue-on-error: true

    - name: Terraform Validate - Layered Architecture
      run: |
        cd terraform
        # Validate each layer independently
        for layer in 01-foundation 02-data 03-database 04-compute 05-monitoring; do
          echo "Validating layer: $layer"
          cd $layer
          terraform init -backend=false
          terraform validate
          cd ..
        done

    - name: TFLint Installation
      uses: terraform-linters/setup-tflint@v4
      with:
        tflint_version: v0.48.0

    - name: TFLint Configuration
      run: |
        cd terraform
        cat > .tflint.hcl << EOF
        plugin "aws" {
          enabled = true
          version = "0.27.0"
          source  = "github.com/terraform-linters/tflint-ruleset-aws"
        }

        rule "terraform_required_version" {
          enabled = true
        }

        rule "terraform_required_providers" {
          enabled = true
        }

        rule "terraform_unused_declarations" {
          enabled = true
        }

        rule "terraform_comment_syntax" {
          enabled = true
        }

        rule "terraform_documented_outputs" {
          enabled = true
        }

        rule "terraform_documented_variables" {
          enabled = true
        }

        rule "terraform_typed_variables" {
          enabled = true
        }

        rule "terraform_module_pinned_source" {
          enabled = true
        }

        rule "terraform_naming_convention" {
          enabled = true
          format  = "snake_case"
        }

        rule "terraform_standard_module_structure" {
          enabled = true
        }
        EOF

    - name: TFLint Run - Layered Architecture
      run: |
        cd terraform
        # Run TFLint on each layer
        for layer in 01-foundation 02-data 03-database 04-compute 05-monitoring; do
          echo "Running TFLint for layer: $layer"
          cd $layer
          tflint --init
          tflint --format=compact
          cd ..
        done

    - name: Checkov Terraform Security Scan - Layered Architecture
      uses: bridgecrewio/checkov-action@master
      continue-on-error: true  # Don't fail pipeline on security findings
      with:
        directory: terraform
        framework: terraform
        config_file: ../.checkov.yml
        output_format: sarif
        output_file_path: checkov-results.sarif
        download_external_modules: true

    - name: TFSec Security Scanner - Layered Architecture
      run: |
        cd terraform
        # Run TFSec on entire terraform directory
        tfsec . --format sarif --out tfsec-results.sarif || true

    - name: Upload TFSec Security Scan Results
      uses: github/codeql-action/upload-sarif@v3
      continue-on-error: true  # Don't fail pipeline on upload issues
      if: always() && hashFiles('terraform/tfsec-results.sarif') != ''
      with:
        sarif_file: terraform/tfsec-results.sarif
        category: tfsec-terraform

    - name: Upload Checkov Security Scan Results
      uses: github/codeql-action/upload-sarif@v3
      continue-on-error: true  # Don't fail pipeline on upload issues
      if: always() && hashFiles('checkov-results.sarif') != ''
      with:
        sarif_file: checkov-results.sarif
        category: checkov-terraform

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: terraform-validate

    env:
      TERRAFORM_VERSION: ${{ needs.terraform-validate.outputs.terraform-version }}
      IS_PRERELEASE: ${{ needs.terraform-validate.outputs.is-prerelease }}

    outputs:
      tfplanExitCode: ${{ steps.tf-plan.outputs.exitcode }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Display Plan Information
      run: |
        if [ "$IS_PRERELEASE" = "true" ]; then
          echo "ðŸš§ **Planning Pre-release Infrastructure Version: \`$TERRAFORM_VERSION\`**" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Pre-release infrastructure will NOT be deployed**" >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ—ï¸ **Planning Production Infrastructure Version: \`$TERRAFORM_VERSION\`**" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        # AWS Role Trusts GitHub OIDC identity provider
        role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE }}
        role-session-name: GitHubActions-Terraform-Plan
        aws-region: ${{ env.AWS_REGION }}
        # Explicit OIDC configuration
        audience: sts.amazonaws.com
        output-env-credentials: true

    - name: Terraform Plan - Staging Environment
      id: tf-plan
      env:
        LAST_LAYER: ${{ env.DEFAULT_LAST_LAYER }}
        ENVIRONMENT: ${{ env.ENVIRONMENT }}
      run: |
        cd terraform
        # Use the layered deployment script for planning
        chmod +x ci/deploy-layers.sh
        export exitcode=0
        ./ci/deploy-layers.sh ${ENVIRONMENT}.tfvars plan $LAST_LAYER || export exitcode=$?

        echo "exitcode=$exitcode" >> $GITHUB_OUTPUT

        if [ $exitcode -eq 1 ]; then
          echo "Terraform Plan Failed"
          exit 1
        elif [ $exitcode -eq 0 ]; then
          echo "Terraform Plan Succeeded"
        else
          echo "Terraform Plan Completed with exit code: $exitcode"
        fi

    - name: Create Terraform Plan Summary
      env:
        ENVIRONMENT: ${{ env.ENVIRONMENT }}
      run: |
        cd terraform
        echo "## Terraform Plan Summary (${ENVIRONMENT^}) - Infrastructure v$TERRAFORM_VERSION" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All layers validated and planned successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Processing Configuration:" >> $GITHUB_STEP_SUMMARY
        echo "- **Infrastructure Version**: \`$TERRAFORM_VERSION\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${ENVIRONMENT}" >> $GITHUB_STEP_SUMMARY
        echo "- **Last layer**: ${{ env.DEFAULT_LAST_LAYER }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Available Layers:" >> $GITHUB_STEP_SUMMARY
        echo "- 1: 01-foundation (VPC, networking, security groups)" >> $GITHUB_STEP_SUMMARY
        echo "- 2: 02-data (S3 buckets, Lambda triggers)" >> $GITHUB_STEP_SUMMARY
        echo "- 3: 03-database (RDS PostgreSQL)" >> $GITHUB_STEP_SUMMARY
        echo "- 4: 04-compute (EKS cluster)" >> $GITHUB_STEP_SUMMARY
        echo "- 5: 05-monitoring (CloudWatch, alarms)" >> $GITHUB_STEP_SUMMARY

    - name: Comment Terraform Plan on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      env:
        PLAN: "terraform\n${{ steps.tf-plan.outputs.stdout }}"
        ENVIRONMENT: ${{ env.ENVIRONMENT }}
      with:
        script: |
          const output = `#### Terraform Plan (${process.env.ENVIRONMENT}) ðŸ“–\`${{ steps.tf-plan.outcome }}\`

          <details><summary>Show Plan (${process.env.ENVIRONMENT})</summary>

          \`\`\`\n
          ${process.env.PLAN}
          \`\`\`

          </details>

          *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [ terraform-validate, terraform-plan ]
    if: |
      github.ref == 'refs/heads/main' &&
      needs.terraform-plan.outputs.tfplanExitCode == '0' &&
      needs.terraform-validate.outputs.is-prerelease == 'false' &&
      (
        (github.event_name == 'push') ||
        (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
      )
    environment:
      name: staging
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    env:
      TERRAFORM_VERSION: ${{ needs.terraform-validate.outputs.terraform-version }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display Apply Information
        run: |
          echo "ðŸš€ **Applying Infrastructure Version: \`$TERRAFORM_VERSION\`**" >> $GITHUB_STEP_SUMMARY

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # AWS Role Trusts GitHub OIDC identity provider
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE }}
          role-session-name: GitHubActions-Terraform-Apply
          aws-region: ${{ env.AWS_REGION }}
          # Explicit OIDC configuration
          audience: sts.amazonaws.com
          output-env-credentials: true

      - name: Terraform Apply - Staging Environment
        env:
          LAST_LAYER: ${{ env.DEFAULT_LAST_LAYER }}
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
        run: |
          cd terraform
          # Use the layered deployment script for applying
          chmod +x ci/deploy-layers.sh
          ./ci/deploy-layers.sh ${ENVIRONMENT}.tfvars apply $LAST_LAYER

      - name: Terraform Output - Staging Environment
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
        run: |
          cd terraform
          echo "## Terraform Apply Results (${ENVIRONMENT^}) - Infrastructure v$TERRAFORM_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Infrastructure successfully applied to ${ENVIRONMENT} environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration:" >> $GITHUB_STEP_SUMMARY
          echo "- **Infrastructure Version**: \`$TERRAFORM_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${ENVIRONMENT^}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: PR merge to main" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Last layer processed**: ${{ env.DEFAULT_LAST_LAYER }}" >> $GITHUB_STEP_SUMMARY

      - name: Export Combined Terraform Outputs
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
        run: |
          cd terraform
          # Export outputs from all layers into a combined JSON
          echo '{}' > combined-outputs-${ENVIRONMENT}.json
          for layer in 01-foundation 02-data 03-database 04-compute 05-monitoring; do
            echo "Collecting outputs from layer: $layer"
            if [ -f "$layer/terraform.tfstate" ]; then
              cd $layer
              terraform output -json >> ../combined-outputs-${ENVIRONMENT}.json || echo "No outputs from $layer"
              cd ..
            fi
          done

      - name: Upload Combined Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-staging-infrastructure
          path: terraform/combined-outputs-staging.json

  terraform-apply-skipped:
    name: Infrastructure Deployment Skipped (Pre-release)
    runs-on: ubuntu-latest
    needs: [ terraform-validate, terraform-plan ]
    if: |
      github.ref == 'refs/heads/main' &&
      needs.terraform-plan.outputs.tfplanExitCode == '0' &&
      needs.terraform-validate.outputs.is-prerelease == 'true' &&
      (
        (github.event_name == 'push') ||
        (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
      )

    env:
      TERRAFORM_VERSION: ${{ needs.terraform-validate.outputs.terraform-version }}

    steps:
      - name: Display Infrastructure Deployment Suppression Notice
        run: |
          echo "ðŸš§ **Infrastructure Deployment Suppressed for Pre-release Version: \`$TERRAFORM_VERSION\`**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Pre-release Infrastructure Version Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Infrastructure deployment has been automatically suppressed because the current version contains a pre-release identifier." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Current Version**: \`$TERRAFORM_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release Behavior**:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform validation completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform plan generated successfully" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš« **Infrastructure deployment suppressed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To enable infrastructure deployment:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Update \`terraform/staging.tfvars\` to use a production version (without -alpha, -beta, or -rc suffix)" >> $GITHUB_STEP_SUMMARY
          echo "2. Create a new pull request with the version change" >> $GITHUB_STEP_SUMMARY
          echo "3. Merge the pull request to trigger infrastructure deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Example production versions**: \`1.0.2\`, \`1.1.0\`, \`2.0.0\`" >> $GITHUB_STEP_SUMMARY

          # Output warning to action logs as well
          echo "::warning title=Infrastructure Deployment Suppressed::Pre-release version $TERRAFORM_VERSION detected - infrastructure deployment has been automatically suppressed"